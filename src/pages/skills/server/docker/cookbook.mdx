import { Callout } from "nextra-theme-docs";

# Docker ê¸°ìˆ  ëª¨ìŒ (ë°°í¬ ìë™í™”, vs Docker + k8s)

## ğŸš€ Next.js í”„ë¡œì íŠ¸ Dockerë¥¼ ì´ìš©í•˜ì—¬ ë°°í¬ ìë™í™”

### 1. Next.js Dcoker ì´ë¯¸ì§€ ë§Œë“¤ê¸°

ì°¸ê³ : [Next.js Dockerfile ì˜ˆì œ](https://github.com/vercel/next.js/blob/canary/examples/with-docker/Dockerfile)  
ì°¸ê³ : [https://bum-developer.tistory.com/entry/Docker-Node-í™˜ê²½-ë§Œë“¤ê¸°](https://bum-developer.tistory.com/entry/Docker-Node-í™˜ê²½-ë§Œë“¤ê¸°) (Dockerfile ì„¤ì •í•˜ê¸°)

1. ìœ„ ë§í¬ë¥¼ ì°¸ê³ í•˜ì—¬ docker imageë¡œ ë§Œë“¤ê¸° ìœ„í•´ ìƒˆ Dockerfileì„ ì¶”ê°€í•œë‹¤.
2. ì¼ë‹¨, ê°€ì¥ ê¸°ë³¸ì´ ë˜ëŠ” Base Imageë¥¼ ì •í•œë‹¤.

```docker
FROM node:18-alpine AS base
```

- node.jsì˜ ê²½ìš° nodeì™€ ë²„ì „ì„ ëª…ì‹œí•œë‹¤.
- alpineì€ ìµœì†Œë‹¨ìœ„ì˜ linux ë²„ì „ì„ ì˜ë¯¸í•œë‹¤.
- ë’¤ì— `AS base`ëŠ” ë³„ì¹­ì„ ì§€ì •í•˜ëŠ” ê²ƒì´ë‹¤.

### 2. NPM íŒ¨í‚¤ì§€ ì„¤ì¹˜

1. npm ì˜ì¡´ì„± ì„¤ì¹˜

```docker
# í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì¢…ì†ì„± ì„¤ì¹˜í•œë‹¤.
FROM base AS deps
```

- `FROM base AS deps`ì˜ ì˜ë¯¸
  - `multi-stage`ë¹Œë“œëŠ” ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ë©° ë¹Œë“œ ë“±ì—ëŠ” í•„ìš”í•˜ì§€ë§Œ ìµœì´ˆ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ì—ëŠ” í•„ìš”ì—†ëŠ” í™˜ê²½ì„ ì œê±°í•  ìˆ˜ ìˆë„ë¡ ë‹¨ê³„ë¥¼ ë‚˜ëˆ„ì–´ì„œ ê¸°ë°˜ ì´ë¯¸ì§€ë¥¼ ë§Œë“œëŠ” ë°©ë²•ì´ë‹¤.
  - ë¹Œë“œì™€ ëŸ¬ë‹ ì´ë¯¸ì§€ë¥¼ ë‚˜ëˆ„ëŠ” `Builder Pattern`, Builderì—ì„œ ë¹Œë“œí•œ ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰í•  ì´ë¯¸ì§€ë¡œ ì „ë‹¬í•´ì£¼ê¸° ìœ„í•´ `COPY`ì˜ `--from`ì˜µì…˜ì„ í†µí•´ ì‹¤í–‰ ì´ë¯¸ì§€ë¡œ ì „ë‹¬í•´ ì¤„ ìˆ˜ ìˆë‹¤.

<Callout type="default">
  ê²°ê³¼ì ìœ¼ë¡œ ë„ì»¤ ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆë¥¼ ì¤„ì´ê¸° ìœ„í•œ ì‘ì—…ì´ë‹¤.
</Callout>

2. lib6c-compatì„ ì„¤ì¹˜í•œë‹¤.
   alpine ì´ë¯¸ì§€ê°€ musl libcëŒ€ì‹  glibc and freindsë¥¼ ì‚¬ìš©í•œë‹¤.  
   libc ì˜ì¡´ì„±ì„ ì°¸ì¡°í•˜ëŠ” ì˜ì¡´ì„± ë¼ì´ë¸ŒëŸ¬ë¦¬ì— ëŒ€í•œ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
   ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ë¬¸ì œê°€ ì—†ê³  ì˜ˆë°© ì°¨ì›ì—ì„œ í•˜ëŠ” ì„ íƒì´ë‹¤.

```docker
RUN apk add --no-cache libc6-compat
```

libc6-compatì´ í•„ìš”í•œ ì´ìœ ë¥¼ ì•Œì•„ë³´ë ¤ë©´ [ì´ê³³ì„](https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine)ì„ í™•ì¸í•˜ì.

3. ì‘ì—… ê²½ë¡œë¥¼ ì„¤ì •í•œë‹¤.
   WORKDIRì€ cd ëª…ë ¹ì´ë‘ ë™ì¼í•˜ë‹¤.  
   app í´ë”ì—ë‹¤ê°€ ì‘ì—… í”„ë¡œì íŠ¸ë¥¼ êµ¬ì„±í•˜ê² ë‹¤ëŠ” ëœ»ì´ë‹¤.

```docker
WORKDIR /app
```

4. í”„ë¡œì íŠ¸ íŒŒì¼ì„ ë³µì‚¬í•œë‹¤.
   ì¼ë°˜ì ìœ¼ë¡œ Dockerfileì—ì„œ íŒŒì¼ì„ ë³µì‚¬í•˜ê³  ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•  ë•Œ Layer Systemìœ¼ë¡œ êµ¬ì„±í•˜ê¸° ë•Œë¬¸ì— ë³€ê²½ì´ ë¹ˆë²ˆí•˜ê²Œ ë°œìƒí•  ê²½ìš° ë§ˆì§€ë§‰ì— ì‘ì„±í•˜ëŠ”ê²ƒì´ ì¢‹ë‹¤.

package.json, pnpm-lock.yamlì€ ê·¸ë¦¬ ë¹ˆë²ˆí•˜ê²Œ ë³€ê²½ë˜ì§€ ì•Šìœ¼ë‹ˆ ì²˜ìŒ ì‘ì„±í•´ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤.

<Callout type="info">
  Dockerfileì€ ëª…ë ¹ì–´ í•œ ì¤„, í•œ ì¤„ì´ Layer í˜•ì‹ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤. ê·¸ë˜ì„œ ë§Œì•½
  ì†ŒìŠ¤ì½”ë“œì¸ src ./ ê°€ ìˆ˜ì •ë  ê²½ìš° ì´í›„ ë ˆì´ì–´ë§Œ ë‹¤ì‹œ ë¹Œë“œë¥¼ í•˜ê³  ë‚˜ë¨¸ì§€ LayerëŠ”
  ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤. ê·¸ë ‡ê²Œë˜ë©´ ì´ë¯¸ì§€ë¥¼ ì œì‘í•˜ëŠ” ì‹œê°„ì„ ë‹¨ì¶•í•˜ê³ , íš¨ìœ¨ì„±ì´
  ë†’ì•„ì§„ë‹¤.
</Callout>

ê·¸ í›„ RUN ëª…ë ¹ì–´ë¥¼ í†µí•´ package.jsonì— ëª…ì‹œë˜ì–´ìˆëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ëª¨ë‘ ì„¤ì¹˜í•œë‹¤.

```docker
RUN npm i
```

### 3. Build í•˜ê¸°

ìœ„ì²˜ëŸ¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•˜ê³  ê·¸ ë‹¤ìŒìœ¼ë¡œëŠ” buildë¥¼ í•œë‹¤.

```docker
# í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì†ŒìŠ¤ ì½”ë“œ ì¬êµ¬ì„±í•˜ì.
FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
# ì´ë ‡ê²Œ í•˜ë©´ ê° í™˜ê²½ì— í•´ë‹¹í•˜ëŠ” í™˜ê²½ íŒŒì¼ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.
COPY .env.development .env.production
RUN yarn build
```

- FROM base AS builder ë¥¼ í•˜ê³  COPY â€”from=depsë¥¼ í•˜ëŠ”ê²ƒì€ ìœ„ì—ì„œ ë¹Œë“œ ì´ë¯¸ì§€ë¥¼ ì¤„ì´ê¸° ìœ„í•œ ì‘ì—…ì´ë‹¤.
- COPY..: í•„ìš”í•œ ëª¨ë“  íŒŒì¼ì„ ë³µì‚¬í•œë‹¤.
- COPY .env.development .env.production: yarn buildëŠ” ê¸°ë³¸ì ìœ¼ë¡œ .env.productuibì„ ë°”ë¼ë³´ê¸°ë•Œë¬¸ì— í˜„ì¬ .env.developmentë¥¼ .env.productionìœ¼ë¡œ ë§Œë“ ë‹¤ìŒì— yarn buildë¥¼ í†µí•´ í•´ë‹¹ ì„¤ì •ëœ í™˜ê²½ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê²Œ ë§Œë“œëŠ” ê²ƒì´ë‹¤.
- RUN yarn build : ìµœì¢… ë¹Œë“œ

### 4. production mode ì´ë¯¸ì§€, ëª¨ë“  íŒŒì¼ ë³µì‚¬ ë° ë‹¤ìŒ ì‹¤í–‰

ìµœì¢… ì‹¤í–‰í•˜ê¸° ìœ„í•œ ì´ë¯¸ì§€ë¥¼ ë§Œë“œëŠ” ë‹¨ê³„ì´ë‹¤.  
ê²°êµ­ ìš°ë¦¬ê°€ ì§„ì§œë¡œ í•„ìš”í•œ ê²ƒì´ í•´ë‹¹ ì´ë¯¸ì§€ì´ë‹¤.

ë”°ë¼ì„œ ë§ˆì°¬ê°€ì§€ë¡œ FROM base AS runnerë¡œ êµ¬ë¶„í•´ì¤€ë‹¤.

```docker
FROM base AS runner
WORKDIR /app
```

NODE_ENVë¥¼ productionìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì„¤ì •í•œë‹¤.

```docker
ENV NODE_ENV production
```

ë¦¬ëˆ…ìŠ¤ gid, uidë¥¼ ìƒì„±í•´ì¤€ë‹¤.

```docker
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs
```

builderëœ ê³³ì— ë§Œë“¤ì–´ì§„ /app/publicì„ í•´ë‹¹ runner ì´ë¯¸ì§€ì— ì¶”ê°€í•´ì£¼ê¸° ìœ„í•´ ë³µì‚¬í•œë‹¤.

```docker
COPY --from=builder /app/public ./public
```

ì•„ë˜ ëª…ë ¹ì„ ìˆ˜í–‰í•˜ëŠ”ë° ê·¸ ì „ì— ì•Œì•„ì•¼ í•  ì‚¬ì „ ì§€ì‹ì´ í•„ìš”í•˜ë‹¤.

```docker
# ì•„ë˜ëŠ” ì¶œë ¥ íŠ¸ë ˆì´ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ í™œìš©í•˜ì—¬ ì´ë¯¸ì§€ í¬ê¸° ì¶•ì†Œí•˜ëŠ” ë°©ë²•ì´ë‹¤.
# https://nextjs.org/docs/advanced-features/output-file-tracing
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static
```

ì°¸ê³ : [https://nextjs.org/docs/pages/api-reference/next-config-js/output](https://nextjs.org/docs/pages/api-reference/next-config-js/output)

Next.js 12ë¶€í„°ëŠ” .next/ ë””ë ‰í† ë¦¬ì˜ ì¶œë ¥ íŒŒì¼ ì¶”ì ì„ í™œìš©í•˜ì—¬ í•„ìš”í•œ íŒŒì¼ë§Œ í¬í•¨í•  ìˆ˜ ìˆë‹¤.

next build ì¤‘ì—, Next.jsëŠ” `@vercel/nft`ë¥¼ ì‚¬ìš©í•˜ì—¬ ê°€ì ¸ì˜¤ê¸°, ìš”êµ¬ ì‚¬í•­ ë° fs ì‚¬ìš©ëŸ‰ì„ ì •ì ìœ¼ë¡œ ë¶„ì„í•˜ì—¬ í˜ì´ì§€ê°€ ë¡œë“œë  ìˆ˜ ìˆëŠ” ëª¨ë“  íŒŒì¼ì„ ê²°ì •í•œë‹¤.  
next.jsì˜ í”„ë¡œë•ì…˜ ì„œë²„ëŠ” í”„ë¡œë•ì…˜ì—ì„œ í™œìš©í•  ìˆ˜ ìˆëŠ” `.next/next-server.js.nft.json`ì—ì„œ í•„ìš”í•œ íŒŒì¼ê³¼ ì¶œë ¥ì„ ì¶”ì í•œë‹¤.

Next.jsëŠ” node_modulesì˜ ì„ íƒ íŒŒì¼ì„ í¬í•¨í•˜ì—¬ í”„ë¡œë•ì…˜ ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë§Œ ë³µì‚¬í•˜ëŠ” ë…ë¦½ ì‹¤í–‰í˜• í´ë”ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•  ìˆ˜ ìˆë‹¤.  
ì´ ìë™ ë³µì‚¬ë¥¼ í™œìš©í•˜ë ¤ë©´ `next.config.js`ì—ì„œ ìë™ ë³µì‚¬ë¥¼ í™œì„±í™”í•˜ë©´ ëœë‹¤.

```js
module.exports = {
  output: "standalone",
};
```

ê·¸ëŸ¬ë©´ `.next/standalone`ì— í´ë”ê°€ ìƒì„±ë˜ê³  node_modulesë¥¼ ì„¤ì¹˜í•˜ì§€ ì•Šê³ ë„ ìì²´ì ìœ¼ë¡œ ë°°í¬í•  ìˆ˜ ìˆê³  ë‹¤ìŒ ì‹œì‘ ëŒ€ì‹  ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ìµœì†Œ server.js íŒŒì¼ë„ ì¶œë ¥ëœë‹¤.

- standaloneë¥¼ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” ì´ë¯¸ì§€ ì‚¬ì´ì¦ˆë¥¼ ì¤„ì¼ ìˆ˜ ìˆë‹¤.

ì‚¬ìš©ì ì„¤ì •

```docker
USER nextjs
```

3000 í¬íŠ¸ ì‚¬ìš© ë° í¬íŠ¸ 3000 í™˜ê²½ë³€ìˆ˜ ì„¤ì •

```docker
EXPOSE 3000
ENV PORT 3000
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ìµœì¢… ì‹¤í–‰. ìœ„ì— standaloneë¡œ ë§Œë“¤ì–´ì¡Œë‹¤ë©´ server.jsë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.

```docker
CMD ["node", "server.js"]
```

### 5. ë„ì»¤ ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°

Dockerfileì„ ì‘ì„±í–ˆë‹¤ë©´ ì´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë„ì»¤ ë¹Œë“œë¥¼ í†µí•´ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ì–´ë³¼ ìˆ˜ ìˆë‹¤.  
ì—¬ê¸°ì„œ -tëŠ” â€”tag ì˜µì…˜ì„ ì˜ë¯¸í•œë‹¤.  
ì´ë¯¸ì§€ ì´ë¦„ì„ ì§€ì •í•œë‹¤ê³  ë³´ë©´ ë  ê±° ê°™ë‹¤.  
ê·¸ë¦¬ê³  . ì€ í˜„ì¬ ê²½ë¡œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§Œë“ ë‹¤ëŠ” ëœ»ì´ë‹¤.

```sh
docker build -t nextjs-docker .
```

ê·¼ë° í˜„ì¬ Dockerfile ê²½ë¡œëŠ” docker í´ë” ì•„ë˜ ìˆë‹¤.  
ê·¸ë˜ì„œ ê·¸ëŸ°ì§€ ì €ë ‡ê²Œ ì‹¤í–‰í•˜ë©´ `failed to read dockerfile` ì´ë¼ëŠ” ì˜¤ë¥˜ê°€ ë‚˜ë©´ì„œ ì‹¤í–‰ì´ ì•ˆëœë‹¤.  
Dockerfileì„ ë°–ìœ¼ë¡œ ë¹¼ë©´ ì˜ ëœë‹¤.

`-f` ì˜µì…˜ì„ í†µí•´ Dockerfile ê²½ë¡œë¥¼ ê°•ì œë¡œ ì§€ì •í•´ì¤„ ìˆ˜ ìˆë‹¤.

```sh
docker build -t nextjs-docker -f ./docker/Dockerfile .
```

ì‹¤í–‰ê³¼ì •

```
â¯ docker build -t nextjs-docker .
[+] Building 16.0s (19/19) FINISHED
 => [internal] load build definition from Dockerfile                                                                                 0.0s
 => => transferring dockerfile: 967B                                                                                                 0.0s
 => [internal] load .dockerignore                                                                                                    0.0s
 => => transferring context: 2B                                                                                                      0.0s
 => [internal] load metadata for docker.io/library/node:18-alpine                                                                    0.8s
 => [internal] load build context                                                                                                    1.3s
 => => transferring context: 3.14MB                                                                                                  1.2s
 => [base 1/1] FROM docker.io/library/node:18-alpine@sha256:f605fcd5254d0e398e04d93c7b11e2aec2a6e1aeb7da1f99bc40cd101dd8cde4         0.0s
 => CACHED [runner 1/6] WORKDIR /app                                                                                                 0.0s
 => CACHED [runner 2/6] RUN addgroup --system --gid 1001 nodejs                                                                      0.0s
 => CACHED [runner 3/6] RUN adduser --system --uid 1001 nextjs                                                                       0.0s
 => CACHED [deps 1/4] RUN apk add --no-cache libc6-compat                                                                            0.0s
 => CACHED [deps 2/4] WORKDIR /app                                                                                                   0.0s
 => CACHED [deps 3/4] COPY package.json pnpm-lock.yaml ./                                                                            0.0s
 => CACHED [deps 4/4] RUN npm install -g pnpm && pnpm install                                                                        0.0s
 => CACHED [builder 2/4] COPY --from=deps /app/node_modules ./node_modules                                                           0.0s
 => [builder 3/4] COPY . .                                                                                                           2.9s
 => [builder 4/4] RUN yarn build                                                                                                    10.2s
 => [runner 4/6] COPY --from=builder /app/public ./public                                                                            0.0s
 => [runner 5/6] COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./                                                  0.1s
 => [runner 6/6] COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static                                          0.0s
 => exporting to image                                                                                                               0.1s
 => => exporting layers                                                                                                              0.1s
 => => writing image sha256:a76d375f14c08f8bde5c5ad7803c1903c6a93aecbbbd49bc898386d3630869a0                                         0.0s
 => => naming to docker.io/library/nextjs-dock
```

ìµœì¢…ì ìœ¼ë¡œ nextjs-dockerë¼ëŠ” ì´ë¯¸ì§€ê°€ ì˜ ë§Œë“¤ì–´ì¡Œë‹¤.

ì´ì œ ë§Œë“¤ì–´ì§„ ë„ì»¤ë¥¼ ì•„ë˜ì™€ ê°™ì´ ì‹¤í–‰í•˜ë©´ ì˜ ë™ì‘í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```sh
â¯ docker run -p 3000:3000 nextjs-docker
info  - Loaded env from /app/.env.production
Listening on port 3000 url: http://e94bfe211f46:3000
```

VSCodeì—ì„œ docker extensionì„ ì„¤ì¹˜í•˜ë©´ docker container ë°”ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

### 6. ë„ì»¤ ì»´í¬ì¦ˆ ì—°ë™í•˜ê¸°

ë„ì»¤ ì»´í¬ì¦ˆëŠ” ì—¬ëŸ¬ê°œì˜ ë„ì»¤ ì»¨í…Œì´ë„ˆë¥¼ ë„ìš°ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” ê°„ë‹¨í•œ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ë„êµ¬ì´ë‹¤.

- docker-compse + nextjs ì°¸ê³  : [https://github.com/vercel/next.js/tree/canary/examples/with-docker-compose](https://github.com/vercel/next.js/tree/canary/examples/with-docker-compose)
- ê¸°ë³¸ ì„¤ì • ì°¸ê³  : [https://nirsa.tistory.com/79](https://nirsa.tistory.com/79)

ê·¸ì „ì— í˜„ì¬ í”„ë¡œì íŠ¸ ê²½ë¡œì™€ docker íŒŒì¼ ìœ„ì¹˜ë¥¼ ì°¸ê³ í•´ì„œ ì ì ˆí•œ ê²½ë¡œë¥¼ ì§€ì •í•´ì¤˜ì•¼ í•œë‹¤.  
next.js ì—ì„œ ì‘ì„±ëœ ê°€ì´ë“œ ì½”ë“œì´ë‹¤.

```sh
version: '3'

services:
  next-app:
    container_name: next-app
		build:
      context: ../
      dockerfile: docker/prod.Dockerfile
      args:
        ENV_VARIABLE: ${ENV_VARIABLE}
        NEXT_PUBLIC_ENV_VARIABLE: ${NEXT_PUBLIC_ENV_VARIABLE}
    restart: always
    ports:
      - 3000:3000
    networks:
      - my_network

    # ì•„ë˜ ì»¨í…Œì´ë„ˆ ì¶”ê°€(nginx, postgres ë“±)

# ì»¨í…Œì´ë„ˆê°€ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì •ì˜
# ì„œë¡œì˜ ì»¨í…Œì´ë„ˆ ì´ë¦„ì„ í˜¸ìŠ¤íŠ¸ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬
networks:
  my_network:
    external: true
```

- container_name: ì»¨í…Œì´ë„ˆì˜ ì´ë¦„ìœ¼ë¡œ next-appì´ë‹¤.
- build.context: í˜„ì¬ í”„ë¡œì íŠ¸ ìœ„ì¹˜ë¥¼ ê°€ë¦¬ì¼œì•¼ í•œë‹¤.
- build.dockerfile: prod.Dockerfile ì„ ì‹¤í–‰ íŒŒì¼ë¡œ ì‚¼ëŠ”ë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.
- build.args: ë¹Œë“œ ì‹œì—ë§Œ ì‚¬ìš© ê°€ëŠ¥í•œ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•œë‹¤.
- restart: always. ì»¨í…Œì´ë„ˆê°€ ë©ˆì¶”ë©´ í•­ìƒ ë‹¤ì‹œ ì‹œì‘í•œë‹¤ëŠ” ëª…ë ¹. ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€ëœ ê²½ìš° ì¬ì‹œì‘ë˜ê±°ë‚˜ ì»¨í…Œì´ë„ˆ ìì²´ê°€ ìˆ˜ë™ìœ¼ë¡œ ì¬ì‹œì‘ë  ë•Œë§Œ ì¬ì‹œì‘ ëœë‹¤.
- networks external : trueë¡œ ì„¸íŒ…ë˜ë©´, networkê°€ Compose ì™¸ë¶€ì—ì„œ ìƒì„±ë˜ì—ˆìŒì„ ì§€ì •í•œë‹¤.

ë¬¸ì„œì— ì‹¤í–‰ ì „ì— networkë¥¼ ìƒì„±í•˜ëŠ” ëª…ë ¹ì´ ìˆë‹¤.

- ì°¸ê³ : [https://great-developer.tistory.com/289](https://great-developer.tistory.com/289)
- ì°¸ê³ : [https://www.daleseo.com/docker-compose-networks/](https://www.daleseo.com/docker-compose-networks/)

```sh
# ì„œë¡œì˜ ì»¨í…Œì´ë„ˆ ì´ë¦„ì„ í˜¸ìŠ¤íŠ¸ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬
# ì»¨í…Œì´ë„ˆê°€ í†µì‹ í•  ìˆ˜ ìˆë„ë¡ ë„¤íŠ¸ì›Œí¬ë¥¼ ë§Œë“ ë‹¤.
docker network create my_network

# docker network list í™•ì¸
docker network ls
```

ë§Œì•½ ìƒì„±ì„ ì•ˆí•˜ë©´ ì•„ë˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

```sh
Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them
network next-app-network declared as external, but could not be found
```

- ìµœì¢…ì ìœ¼ë¡œ ë„ì»¤ ì»´í¬ì¦ˆ ì‹¤í–‰í•´ë³´ê¸°.

`up -d`ëŠ” ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰í•˜ê² ë‹¤ëŠ” ëœ»ì´ë‹¤.  
ì‹¤í–‰ì‹œ í˜„ì¬ ê²½ë¡œì— ë”°ë¼ docker-compose.prod.ymlì€ ë§ì¶°ì¤˜ì•¼ í•œë‹¤.  
ì‹¤í–‰ ê²°ê³¼ ì„±ê³µì ìœ¼ë¡œ ë˜ì—ˆìŠµë‹ˆë‹¤.

```
â¯ docker-compose -f docker-compose.prod.yml up -d
[+] Running 1/1
 â ¿ Container next-app  Started
```

ì°¸ê³ : [https://github.com/vercel/next.js/tree/canary/examples/with-docker-multi-env](https://github.com/vercel/next.js/tree/canary/examples/with-docker-multi-env)

ë°°í¬í™˜ê²½ì— ë”°ë¼ development, staging, productionì„ êµ¬ë¶„í•´ì„œ ë§Œë“œëŠ” ë°©ë²•ì´ë‹¤.

---


## ğŸš€ GitHub Actionsì™€ ì—°ë™í•œ Next.js Docker ë°°í¬ ìë™í™”

### âœ… ì „ì²´ íë¦„ ìš”ì•½

1. **Next.js í”„ë¡œì íŠ¸ë¥¼ Docker ì´ë¯¸ì§€ë¡œ ë¹Œë“œ**
2. **GitHub Actionsë¡œ CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì„±**
3. **Docker Hub ë˜ëŠ” AWS ECRë¡œ ì´ë¯¸ì§€ Push**
4. **EC2 ë˜ëŠ” EKSì—ì„œ Pull í›„ ë°°í¬ ìë™í™”**

---

### ğŸ”§ 1. GitHub Actions Workflow íŒŒì¼ êµ¬ì„± (`.github/workflows/deploy.yml`)

```yaml
name: Deploy Next.js Docker App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./docker/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/nextjs-docker:latest

      - name: SSH Remote Deploy (EC2 or VPS)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            docker pull ${{ secrets.DOCKER_USERNAME }}/nextjs-docker:latest
            docker stop nextjs || true && docker rm nextjs || true
            docker run -d --name nextjs -p 3000:3000 ${{ secrets.DOCKER_USERNAME }}/nextjs-docker:latest
```

---

### ğŸ” 2. GitHub Secrets ë“±ë¡ í•­ëª©

| í‚¤ ì´ë¦„              | ì„¤ëª…                            |
| ----------------- | ----------------------------- |
| `DOCKER_USERNAME` | Docker Hub ID                 |
| `DOCKER_PASSWORD` | Docker Hub ë¹„ë°€ë²ˆí˜¸ ë˜ëŠ” í† í°         |
| `SSH_HOST`        | EC2 ë˜ëŠ” VPS IP ì£¼ì†Œ              |
| `SSH_USER`        | ë¦¬ëˆ…ìŠ¤ ì‚¬ìš©ì (ì˜ˆ: `ubuntu`)         |
| `SSH_KEY`         | EC2 ê°œì¸ í‚¤ (`.pem` íŒŒì¼ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìŒ) |

---

### ğŸ’¡ ì°¸ê³  ì‚¬í•­

* ìœ„ ë°©ì‹ì€ GitHub Actionsë¥¼ ì´ìš©í•´ ìë™ìœ¼ë¡œ **Docker ì´ë¯¸ì§€ ë¹Œë“œ â†’ Docker Hubì— Push â†’ ì„œë²„ì— ë°°í¬**ê¹Œì§€ ì§„í–‰ëœë‹¤.
* EC2ê°€ ì•„ë‹Œ **Kubernetes (EKS)** ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, `kubectl apply -f deployment.yaml` ë˜ëŠ” Helm ë°°í¬ ë‹¨ê³„ë¡œ ëŒ€ì²´í•  ìˆ˜ ìˆë‹¤.
* ë‹¤ì¤‘ í™˜ê²½ (dev/stage/prod) êµ¬ë¶„ì„ ìœ„í•´ `deploy-dev.yml`, `deploy-prod.yml` ë“±ìœ¼ë¡œ ì›Œí¬í”Œë¡œë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤.

---

## ğŸ” Dockerë§Œ ì‚¬ìš©í•˜ëŠ” CI/CD vs Docker + Kubernetes(EKS) ê¸°ë°˜ CI/CD

| í•­ëª©            | Dockerë§Œ ì‚¬ìš©í•˜ëŠ” CI/CD                                                  | Docker + Kubernetes(EKS) ê¸°ë°˜ CI/CD                                                                           |
| ------------- | ------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------- |
| âœ… **ì¥ì **      | - ë‹¨ìˆœí•œ ì„œë²„ì— ì»¨í…Œì´ë„ˆ ì‹¤í–‰ë§Œìœ¼ë¡œ ë°°í¬ ê°€ëŠ¥<br />- ì„¤ì •ê³¼ ìš´ì˜ì´ ê°„ë‹¨í•¨<br />- EC2 ë“± ë‹¨ì¼ ì„œë²„ í™˜ê²½ì— ì í•© | - **í™•ì¥ì„±**: ì˜¤í† ìŠ¤ì¼€ì¼ë§, ë¡¤ë§ ì—…ë°ì´íŠ¸ ë“± ê°€ëŠ¥<br />- **ë³µêµ¬ì„±**: ì¥ì•  ë°œìƒ ì‹œ ìë™ ì¬ì‹œì‘<br />- **ìš´ì˜ ìë™í™”**: Helm, Ingress, HPA ë“±ìœ¼ë¡œ ìœ ì—°í•œ ìš´ì˜ |
| âŒ **ë‹¨ì **      | - ì¥ì•  ë³µêµ¬ ìˆ˜ë™ ì²˜ë¦¬<br />- ë¬´ì¤‘ë‹¨ ë°°í¬ ì–´ë ¤ì›€<br />- ì»¨í…Œì´ë„ˆë¼ë¦¬ì˜ í†µì‹  ë° êµ¬ì„± ë³µì¡í•¨              | - ì´ˆê¸° ì…‹ì—… ë³µì¡ (IAM, EKS í´ëŸ¬ìŠ¤í„°, yaml ë°°í¬ ì„¤ì •)<br />- ëŸ¬ë‹ì»¤ë¸Œ ì¡´ì¬ (kubectl, manifests, Helm ë“± í•„ìš”)                         |
| ğŸš€ **ì í•©í•œ ìƒí™©** | - ë‹¨ì¼ ì„œë²„ë‚˜ ê°„ë‹¨í•œ í”„ë¡œì íŠ¸<br />- ì†Œê·œëª¨ íŠ¸ë˜í”½ ì„œë¹„ìŠ¤                                  | - **í”„ë¡œë•ì…˜ ìˆ˜ì¤€**, **ë‹¤ìˆ˜ ì„œë¹„ìŠ¤ ìš´ì˜**, **íŠ¸ë˜í”½ í™•ì¥ì„± ìš”êµ¬**ë˜ëŠ” ìƒí™©                                                           |
| ğŸ› ï¸ **ë°°í¬ ë°©ì‹** | GitHub Actions â†’ Docker ì´ë¯¸ì§€ ë¹Œë“œ & EC2/VM ì‹¤í–‰                          | GitHub Actions â†’ Docker ì´ë¯¸ì§€ ë¹Œë“œ & ECR í‘¸ì‹œ â†’ EKSì— ìë™ ë°°í¬                                                        |

---

### ğŸ“Œ ê²°ë¡ 

* **Dockerë§Œ ì‚¬ìš©í•˜ëŠ” ë°©ì‹**ì€ **ë¹ ë¥´ê²Œ MVPë¥¼ ë°°í¬**í•˜ê±°ë‚˜ ì†Œê·œëª¨ í”„ë¡œì íŠ¸ì— ì í•©í•˜ë‹¤.
* **Docker + EKS(Kubernetes)** ê¸°ë°˜ì€ **ëŒ€ê·œëª¨ íŠ¸ë˜í”½ ëŒ€ì‘**, **ë¬´ì¤‘ë‹¨ ë°°í¬**, **ë³µìˆ˜ ì»¨í…Œì´ë„ˆ ì¡°í•© (DB, Redis ë“±)** ì— ìœ ë¦¬í•œ êµ¬ì¡°ì´ë‹¤.

ğŸ‘‰ ë”°ë¼ì„œ **ê·œëª¨ê°€ ì»¤ì§ˆìˆ˜ë¡ Kubernetes ê¸°ë°˜ ìë™í™”ê°€ ìœ ë¦¬**í•˜ë‹¤.

---
