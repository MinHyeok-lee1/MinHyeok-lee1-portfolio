# â˜¸ï¸ Kubernetes ê¸°ìˆ  ëª¨ìŒ (ë°°í¬ ìë™í™”, Github Actions)

## ğŸš€ Next.js + Docker + Kubernetes ë°°í¬ ìë™í™” (on AWS)

### âœ… 1. ê°œìš” ë° íë¦„ ìš”ì•½

```
Next.js â†’ Docker Image â†’ Kubernetes Deployment â†’ AWS EKS(Elastic Kubernetes Service)
```

* **Next.js í”„ë¡œì íŠ¸**ëŠ” Dockerfileì„ í†µí•´ ì´ë¯¸ì§€ë¥¼ ìƒì„±
* í•´ë‹¹ ì´ë¯¸ì§€ë¥¼ ECR (AWS Elastic Container Registry)ì— Push
* **Kubernetes**ë¥¼ í†µí•´ AWS EKS í´ëŸ¬ìŠ¤í„°ì— ë°°í¬
* í•„ìš” ì‹œ Ingress Controller + LoadBalancer + Auto Scaling êµ¬ì„±

---

### ğŸ§± 2. ì „ì œ ì¡°ê±´

* AWS CLI ë° EKS CLI (`eksctl`) ì„¤ì¹˜
* AWS ECR ì‚¬ìš©ì„ ìœ„í•œ IAM ê¶Œí•œ
* Docker, kubectl, Helm ì„¤ì¹˜
* EKS í´ëŸ¬ìŠ¤í„° ìƒì„± ì™„ë£Œ ìƒíƒœ
* `next.config.js`ì—ì„œ `output: "standalone"` ì ìš©

---

### ğŸ³ 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR Push

```sh
# ECR ë¦¬í¬ì§€í† ë¦¬ ìƒì„±
aws ecr create-repository --repository-name nextjs-app

# ë¡œê·¸ì¸ (ë¦¬ëˆ…ìŠ¤/Mac)
aws ecr get-login-password | docker login --username AWS --password-stdin <account-id>.dkr.ecr.<region>.amazonaws.com

# ì´ë¯¸ì§€ ë¹Œë“œ ë° íƒœê¹…
docker build -t nextjs-app .
docker tag nextjs-app:latest <account-id>.dkr.ecr.<region>.amazonaws.com/nextjs-app:latest

# ECRì— Push
docker push <account-id>.dkr.ecr.<region>.amazonaws.com/nextjs-app:latest
```

---

### â˜¸ï¸ 4. Kubernetes ë°°í¬ ì„¤ì •

#### ğŸ”§ `nextjs-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nextjs-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nextjs-app
  template:
    metadata:
      labels:
        app: nextjs-app
    spec:
      containers:
        - name: nextjs
          image: <ECR ì´ë¯¸ì§€ ê²½ë¡œ>
          ports:
            - containerPort: 3000
```

#### ğŸŒ `nextjs-service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nextjs-service
spec:
  type: LoadBalancer  # ë˜ëŠ” NodePort
  selector:
    app: nextjs-app
  ports:
    - port: 80
      targetPort: 3000
```

---

### ğŸ“¡ 5. ë°°í¬ ëª…ë ¹ì–´

```sh
kubectl apply -f nextjs-deployment.yaml
kubectl apply -f nextjs-service.yaml
```

* ì™¸ë¶€ IP í™•ì¸:

```sh
kubectl get svc nextjs-service
```

---

### ğŸ§© 6. Ingress ì—°ë™ (ì„ íƒ)

Ingress Controller ì„¤ì¹˜ (ì˜ˆ: NGINX)

```sh
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm install ingress-nginx ingress-nginx/ingress-nginx
```

Ingress ì„¤ì • íŒŒì¼ ì¶”ê°€:

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nextjs-ingress
spec:
  rules:
    - host: nextjs.yourdomain.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: nextjs-service
                port:
                  number: 80
```

ë„ë©”ì¸ê³¼ SSL ì ìš©ì€ `cert-manager` + `Let's Encrypt` ì—°ë™ ê°€ëŠ¥.

---

### ğŸ“ˆ 7. í™•ì¥ ë° ìš´ì˜ ìë™í™” (ì˜µì…˜)

* **HPA** (Horizontal Pod Autoscaler):

  ```sh
  kubectl autoscale deployment nextjs-app --cpu-percent=50 --min=2 --max=10
  ```

* **CI/CD ì—°ë™**: GitHub Actionsë¡œ ECR push + kubectl ë°°í¬ ìë™í™”

* **ëª¨ë‹ˆí„°ë§**: Prometheus + Grafana / AWS CloudWatch ì—°ë™

---

### âœ… ê²°ë¡ 

| êµ¬ì„± ìš”ì†Œ      | ì—­í•                            |
| ---------- | ---------------------------- |
| Docker     | Next.js ì•±ì„ ê²½ëŸ‰í™”ëœ ì´ë¯¸ì§€ë¡œ í¬ì¥      |
| ECR        | AWSì—ì„œ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì €ì¥ì†Œ ì—­í•         |
| Kubernetes | ë°°í¬, ìŠ¤ì¼€ì¼ë§, ë„¤íŠ¸ì›Œí‚¹ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜       |
| EKS        | AWSì—ì„œ Kubernetes ê´€ë¦¬í˜• í´ëŸ¬ìŠ¤í„° ì œê³µ |
| Ingress    | ë„ë©”ì¸ ê¸°ë°˜ ë¼ìš°íŒ… ë° SSL ì—°ë™          |

---

## ğŸš€ GitHub Actionsë¥¼ í™œìš©í•œ Next.js â†’ Docker â†’ AWS ECR â†’ EKS ìë™ ë°°í¬

### ğŸ“ ë””ë ‰í† ë¦¬ êµ¬ì¡° ì˜ˆì‹œ

```
.
â”œâ”€â”€ .github
â”‚   â””â”€â”€ workflows
â”‚       â””â”€â”€ deploy.yml
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ next.config.js
â”œâ”€â”€ ...
```

---

### âš™ï¸ 1. GitHub Secrets ë“±ë¡

| ì´ë¦„                      | ì„¤ëª…                              |
| ----------------------- | ------------------------------- |
| `AWS_ACCESS_KEY_ID`     | IAM ìœ ì €ì˜ Access Key              |
| `AWS_SECRET_ACCESS_KEY` | IAM ìœ ì €ì˜ Secret Key              |
| `AWS_REGION`            | ì˜ˆ: `ap-northeast-2`             |
| `ECR_REPOSITORY`        | ì˜ˆ: `nextjs-app`                 |
| `EKS_CLUSTER_NAME`      | ì˜ˆ: `my-eks-cluster`             |
| `KUBE_CONFIG_DATA`      | base64 ì¸ì½”ë”©ëœ `~/.kube/config` ë‚´ìš© |

â€» `KUBE_CONFIG_DATA` ìƒì„±:

```bash
cat ~/.kube/config | base64
```

---

### ğŸ“ 2. `.github/workflows/deploy.yml`

```yaml
name: Deploy to EKS

on:
  push:
    branches:
      - main

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and Push Docker image
        run: |
          docker build -t ${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} .
          docker tag ${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }} ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
          docker push ${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}

      - name: Decode kubeconfig
        run: |
          echo "${{ secrets.KUBE_CONFIG_DATA }}" | base64 --decode > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig

      - name: Update K8s deployment image
        run: |
          kubectl config use-context arn:aws:eks:${{ secrets.AWS_REGION }}:<ACCOUNT_ID>:cluster/${{ secrets.EKS_CLUSTER_NAME }}
          kubectl set image deployment/nextjs-app nextjs=${{ steps.login-ecr.outputs.registry }}/${{ secrets.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
```

---

### ğŸ“Œ 3. Deployment.yaml ë³€ê²½ ì˜ˆì‹œ

`image:` ê°’ì„ GitHub Actionsì—ì„œ ì‚¬ìš©í•˜ëŠ” í˜•ì‹ì— ë§ê²Œ:

```yaml
containers:
  - name: nextjs
    image: <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com/nextjs-app:<IMAGE_TAG>
```

â€» `IMAGE_TAG`ëŠ” Git SHAë¡œ ìë™ ì²˜ë¦¬ë˜ë¯€ë¡œ í•­ìƒ ìµœì‹  ì»¤ë°‹ ê¸°ì¤€ìœ¼ë¡œ ë°°í¬ë©ë‹ˆë‹¤.

---

### âœ… ê²°ê³¼

* `main` ë¸Œëœì¹˜ì— í‘¸ì‹œí•˜ë©´:

  1. Docker ì´ë¯¸ì§€ê°€ ë¹Œë“œë˜ê³  ECRì— í‘¸ì‹œë¨
  2. EKS í´ëŸ¬ìŠ¤í„°ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ Deploymentì˜ ì´ë¯¸ì§€ê°€ ìƒˆ íƒœê·¸ë¡œ ì—…ë°ì´íŠ¸ë¨
  3. ë¡¤ë§ ì—…ë°ì´íŠ¸ë¡œ ë¬´ì¤‘ë‹¨ ë°°í¬

---
