# 🔌 STM32 Power Mode 완전 정복: RTOS 기반에서도 적용되는 저전력 전략

## 🧠 PWR 모드 개요

STM32 시리즈는 뛰어난 전력 효율을 제공하기 위해 다양한 **전원 관리 모드(Power Modes)**를 지원  
RTOS 환경에서도 `osDelay()`와 같은 함수와 병행해 아래의 저전력 모드를 적절히 조합하면 **배터리 수명 연장**, **열 발생 최소화**, **시스템 응답 최적화**에 큰 도움이 됨

---

## 🔋 STM32 전력 모드 요약표

| 모드       | 동작 상태 요약                            | 소비 전력 🔋 | 복귀 속도 ⏱ | RAM 유지 🧠 | 상태 유지 📦 |
|------------|-----------------------------------------|--------------|-------------|-------------|---------------|
| **RUN**    | CPU 및 모든 클럭 정상 동작                  | 🔼 높음       | -           | ✅           | ✅             |
| **LPRUN**  | CPU 저속 클럭에서 동작                     | ⬇️ 낮음       | -           | ✅           | ✅             |
| **SLEEP**  | CPU 정지, 주변장치/인터럽트 유지              | ⬇️ 낮음       | ⚡ 빠름       | ✅           | ✅             |
| **STOP**   | 거의 모든 클럭 중지 (RAM 유지)               | ⬇️⬇️ 매우 낮음  | ⏱ 느림       | ✅           | ✅             |
| **STANDBY**| RAM 및 상태 소멸, 리셋 후 부팅                 | ⬇️⬇️⬇️ 극저전력 | 🐢 느림       | ❌           | ❌             |
| **SHUTDOWN**| STANDBY보다 더 낮은 소비 전력 (일부 MCU 한정) | 💤 최저       | 🐢 느림       | ❌           | ❌             |
| **VBAT**   | RTC 및 백업 레지스터 유지 (배터리 기반)         | ♻️ 초저전력     | -           | ❌           | RTC만 유지      |

---

## 🧰 HAL API 예시

```c
HAL_PWR_EnterSLEEPMode(PWR_MAINREGULATOR_ON, PWR_SLEEPENTRY_WFI);
HAL_PWR_EnterSTOPMode(PWR_LOWPOWERREGULATOR_ON, PWR_STOPENTRY_WFI);
HAL_PWR_EnterSTANDBYMode();
```

---

## 🚦 STOP vs STANDBY: 체감 UX 비교

| 항목             | **STOP**             | **STANDBY**          |
| -------------- | -------------------- | -------------------- |
| 복귀 시간          | ⚡ 수\~수십 μs           | 🐢 수 ms 이상 (사실상 리셋)  |
| RAM/레지스터 상태 유지 | ✅ 모두 유지              | ❌ 모두 소멸              |
| 시스템 상태         | 이전 작업 그대로 재개 가능      | 처음부터 재부팅             |
| 전력 소비          | **수십 μA** 수준         | **수 μA 이하** (초절전)    |
| 사용자 체감         | 📱 화면 꺼졌다가 바로 켜지는 느낌 | 🔌 완전히 꺼졌다가 전원 켠 느낌  |
| Wakeup 방식      | 다양한 인터럽트, RTC 지원     | RTC 알람, WKUP 핀 등 제한적 |

---

## 🧠 선택 가이드: 목적에 따라 고르기

| 목표                  | 추천 모드              | 이유                           |
| ------------------- | ------------------ | ---------------------------- |
| 빠른 응답 및 동작 재개 필요    | **STOP**           | RAM 유지, 빠른 복귀                |
| 장시간 슬립, 전력 극한 절감 필요 | **STANDBY**        | 완전 초기화 감수하고 초절전 유지           |
| RTC만 남기고 배터리 보전 필요  | **VBAT**           | RTC만 유지되며 전력 극소              |
| RTOS 동작 중 대기 시간 최소화 | **SLEEP or LPRUN** | 주변장치 유지하며 context switch 최적화 |

---

## 📱 실제 시나리오 예

| 시나리오                        | 추천 모드       | 설명                          |
| --------------------------- | ----------- | --------------------------- |
| 리모컨 버튼 눌렀을 때 즉시 응답해야 함      | **STOP**    | RAM 유지되고, 수 μs 단위로 즉시 복귀 가능 |
| 하루 1번 센싱 후 대기               | **STANDBY** | 완전 초기화되더라도 전력 절감이 중요        |
| BLE 비콘/센서가 짧은 주기로 방송        | **SLEEP**   | CPU만 슬립, 주변장치는 그대로 유지 가능    |
| 스마트워치 화면 꺼짐 상태              | **STOP**    | 빠르게 켜지면서 이전 상태 유지           |
| 환경 센서가 밤 동안 대기 후 아침에 작동해야 함 | **STANDBY** | RTC 알람으로 아침에 자동 부팅 가능       |

---

## ✅ 요약 정리

* **SLEEP**: CPU만 잠들고 나머지는 그대로 빠르게 깨어남
* **STOP**: CPU + 클럭 다 잠들지만 RAM은 살아있고 빠른 복귀 가능
* **STANDBY**: 전부 잠들고 다시 켜면 초기화되지만 하지만 초절전
* **SHUTDOWN**: 일부 MCU만 절전, STANDBY보다 더 절전
* **VBAT**: RTC/백업용 전용 도메인

---

> STM32는 목적에 맞는 전력 모드를 활용하면 배터리 수명을 극대화할 수 있음  
> RTOS 환경에서도 적절한 `osDelay()` + `__WFI()` 조합을 통해 유연하게 전환이 가능하니,  
> **시스템 동작 목적**, **응답성 요건**, **배터리 수명 요구**에 맞춰 **전력 모드 전략을 세분화**하는 것이 중요

---

## 🔚 참고 팁

💬 **실제 제품 개발에서의 전력 전략은 '성능'보다 '지속성'이 더 중요할 수 있음**  
그만큼 이 표와 설명을 참고해, 설계 초기부터 전력 관리 시나리오를 포함시키는 것을 권장

1. `__WFI()` 또는 `__WFE()` 호출로 실제 진입 제어 가능
2. FreeRTOS 사용 시 `configUSE_TICKLESS_IDLE` 설정 고려
3. Stop 모드에서 빠르게 깨어나기 위해 RTC, EXTI, UART-Wakeup 등 외부 이벤트 구성 권장
